<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI-Powered Abbreviation & Expansion Tool (Secure)</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Use Inter font and ensure high contrast black/white theme */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #000000; /* Pure Black background */
            color: #F0F0F0; /* Off-White text */
        }
        
        .app-card {
            background-color: #0d1117; /* Very dark grey background for dashboard container */
            border-color: #2d3748;
        }

        /* Custom scrollbar for the textarea and abbreviation list */
        textarea::-webkit-scrollbar, #abbreviationList::-webkit-scrollbar {
            width: 8px;
        }
        textarea::-webkit-scrollbar-thumb {
            background-color: #444444; /* Dark Grey scrollbar */
            border-radius: 4px;
        }
        textarea::-webkit-scrollbar-track, #abbreviationList::-webkit-scrollbar-track {
            background-color: #111111;
        }
        
        /* Styling for the abbreviation list - using flex/grid for a cleaner list */
        #abbreviationList {
            max-height: 400px;
            overflow-y: auto;
        }
        
        /* Tailwind Button Customization (Conversion Buttons) */
        .conversion-btn {
            @apply font-bold py-3 px-4 rounded-xl shadow-lg transition duration-300 ease-in-out transform hover:scale-[1.03] active:scale-[0.98] text-white ring-4 ring-opacity-30;
        }
        
        /* Adjusted for larger, square icon buttons (utility buttons) */
        .utility-btn {
            @apply h-10 w-10 p-2 rounded-md shadow-md transition duration-200 ease-in-out transform hover:bg-gray-700 active:scale-[0.95] text-gray-200 flex items-center justify-center;
        }

        /* Gradient definitions for AI buttons (Purple Theme) */
        .btn-abbreviate {
            /* Dark Purple to Magenta */
            background-image: linear-gradient(to right, #8B5CF6, #C084FC); 
            --tw-ring-color: #8B5CF6;
        }
        .btn-expand {
            /* Lighter Purple/Lavender to Blue-Purple */
            background-image: linear-gradient(to right, #A78BFA, #D8B4FE); 
            --tw-ring-color: #A78BFA;
        }

        .loading-spinner {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top: 4px solid #fff;
            width: 16px;
            height: 16px;
            animation: spin 1s linear infinite;
            margin-right: 8px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="min-h-screen p-4 sm:p-8 flex items-start justify-center">

    <!-- Status Messages (Top Level) -->
    <div id="status-message" class="fixed top-4 right-4 p-3 rounded-lg text-sm hidden shadow-xl"></div>

    <!-- AUTHENTICATION/LOGIN CONTAINER (Visible when unauthorized) -->
    <div id="auth-container" class="app-card p-8 rounded-2xl shadow-xl w-full max-w-sm flex flex-col items-center justify-center text-center mt-20 hidden">
        <h2 class="text-3xl font-bold text-white mb-4">Secure Access Required</h2>
        <p class="text-gray-400 mb-6">This tool is restricted to Agoda employees. Please sign in with your **@agoda.com** email.</p>
        <button onclick="handleGoogleSignIn()" class="conversion-btn w-full flex items-center justify-center space-x-2 bg-blue-600 hover:bg-blue-700 ring-blue-500/50">
            <!-- Google Icon SVG (Simplified) -->
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 48 48" width="24px" height="24px" class="text-white fill-current"><path fill="#FFC107" d="M43.611,20.083H42V20H24v8h11.303c-1.649,4.657-6.08,8-11.303,8c-6.627,0-12-5.373-12-12s5.373-12,12-12c3.059,0,5.842,1.158,7.961,3.039l5.657-5.657C34.046,6.053,29.268,4,24,4C12.955,4,4,12.955,4,24s8.955,20,20,20c11.045,0,20-8.955,20-20C44,22.659,43.862,21.35,43.611,20.083z"/><path fill="#FF3D00" d="M6.306,14.691l6.571,4.819C14.655,15.108,18.991,12,24,12c3.059,0,5.842,1.158,7.961,3.039l5.657-5.657C34.046,6.053,29.268,4,24,4C12.955,4,4,12.955,4,24l2.306-9.309z"/><path fill="#4CAF50" d="M24,44c5.166,0,9.86-1.977,13.409-5.192l-6.19-5.238C29.211,35.091,26.715,36,24,36c-5.202,0-9.619-3.317-11.283-7.946l-6.522,5.025C9.505,39.556,16.227,44,24,44z"/><path fill="#1976D2" d="M43.611,20.083H42V20H24v8h11.303c-0.792,2.237-2.231,4.166-4.087,5.571c0.001-0.001,0.002-0.001,0.003-0.002l6.19,5.238C36.971,39.205,44,34,44,24C44,22.659,43.862,21.35,43.611,20.083z"/></svg>
            <span>Sign In with Agoda Google Account</span>
        </button>
    </div>

    <!-- Application Dashboard / CONVERTER (Hidden until authorized) -->
    <div id="app-dashboard" class="w-full max-w-5xl app-card p-6 sm:p-10 rounded-2xl shadow-2xl shadow-gray-900/50 border hidden">
        
        <!-- Header -->
        <header class="mb-8">
            <!-- AGODA LOGO (Top Left) -->
            <div class="flex items-center justify-between mb-6">
                <img 
                    src="https://placehold.co/100x40/000000/FFFFFF?text=AGODA" 
                    alt="Agoda Logo Placeholder" 
                    class="rounded-lg shadow-md border border-gray-700"
                >
                <div id="user-info" class="text-xs text-gray-500 text-right italic"></div>
            </div>
            
            <!-- Main Title (Centered) -->
            <div class="text-center">
                <h1 class="text-4xl sm:text-5xl font-extrabold text-white">
                    Note Converter
                </h1>
                <p class="text-gray-500 mt-1 mb-3 text-sm italic">Created by: m.ameen@agoda.com</p>
            </div>
        </header>

        <!-- Grid Container for Input (40% width) and AI Buttons (60% width) -->
        <div class="grid grid-cols-1 lg:grid-cols-5 gap-6 mb-8">
            
            <!-- Left Column: Text Input (40% width) -->
            <div class="lg:col-span-2">
                <div class="relative">
                    <label for="textInput" class="block text-lg font-medium text-gray-300 mb-2">Input Text / Abbreviated Note</label>
                    
                    <!-- Utility Icons Container: Absolute position top-right -->
                    <div id="utilityIcons" class="absolute right-0 top-0 flex space-x-2">
                        <!-- Clear Text Button (Icon only) -->
                        <button onclick="clearText()" class="utility-btn bg-gray-800 hover:bg-gray-600" title="Clear Input Text">
                            <!-- Trash/Clear Icon -->
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-trash-2"><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M10 11v6"/><path d="M14 11v6"/><path d="M15 6V4c0-1-1-2-2-2h-2c-1 0-2 1-2 2v2"/></svg>
                        </button>

                        <!-- Copy Note Button (Icon only) -->
                        <button onclick="copyToClipboard()" class="utility-btn bg-gray-600 hover:bg-gray-500" title="Copy Note to Clipboard">
                            <!-- Copy Icon -->
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-copy"><rect width="14" height="14" x="8" y="8" rx="2" ry="2"/><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"/></svg>
                        </button>
                    </div>
                    
                    <textarea
                        id="textInput"
                        rows="12"
                        placeholder="Paste your full sentence or your abbreviated note here..."
                        class="w-full p-4 text-xl bg-gray-900 text-gray-100 border border-gray-700 rounded-xl focus:ring-gray-500 focus:border-gray-500 ring-2 ring-transparent focus:ring-4 transition duration-200 resize-none mt-2"
                        spellcheck="false"
                    ></textarea>
                </div>
            </div>

            <!-- Right Column: AI Buttons (60% width, stacked vertically and centered) -->
            <div class="lg:col-span-3 flex flex-col gap-4 items-center justify-center">
                
                <!-- AI Conversion Buttons - Reduced width and rounded-xl -->
                <button id="abbreviateBtn" onclick="convertTo('abbreviate')" class="conversion-btn btn-abbreviate ring-violet-500/50 flex items-center justify-center max-w-xs w-full">
                    Abbreviate (AI)
                </button>
                <button id="expandBtn" onclick="convertTo('expand')" class="conversion-btn btn-expand ring-purple-400/50 flex items-center justify-center max-w-xs w-full">
                    Expand Text (AI)
                </button>
                
                <!-- Spacing (Keeping a divider here to separate AI from input) -->
                <div class="border-t border-gray-800 my-2 lg:hidden"></div>

            </div>
        </div>

        <!-- Abbreviation Reference Section -->
        <div class="mt-12 pt-8 border-t border-gray-800">
            <h2 class="text-xl font-semibold text-white mb-3">Abbreviation Dictionary Reference</h2>
            <p class="text-gray-400 mb-4 text-sm">This dictionary guides the AI. <span class="text-gray-400 font-bold border-b border-gray-400 italic">Typos</span> and <span class="text-gray-500 font-bold italic">Synonyms</span> are highlighted by styling, not color.</p>
            <div id="abbreviationList" class="bg-gray-900 p-4 rounded-xl text-sm grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-x-6 gap-y-3 shadow-inner border border-gray-800">
                <!-- Abbreviations loaded by JS will go here -->
            </div>
        </div>
    </div>

    <script type="module">
        // --- FIREBASE IMPORTS ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, GoogleAuthProvider, signInWithPopup, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- GLOBAL ENVIRONMENT VARIABLES ---
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        
        // --- FIREBASE INSTANCES ---
        let app, db, auth;
        let currentUserId = null;
        
        // --- UI ELEMENTS ---
        const statusMessageEl = document.getElementById('status-message');
        const appDashboardEl = document.getElementById('app-dashboard');
        const authContainerEl = document.getElementById('auth-container');
        const userInfoEl = document.getElementById('user-info');
        
        // --- CONVERTER ELEMENTS ---
        const textInput = document.getElementById('textInput');
        const abbreviationList = document.getElementById('abbreviationList');
        const abbreviateBtn = document.getElementById('abbreviateBtn');
        const expandBtn = document.getElementById('expandBtn');


        // Use Debug logging for development
        setLogLevel('Debug');

        // --- UTILITY FUNCTIONS ---

        /**
         * Generic message display helper.
         */
        function showMessage(text, isSuccess) {
            statusMessageEl.textContent = text;
            statusMessageEl.classList.remove('hidden', 'bg-red-800', 'bg-green-800', 'text-red-200', 'text-green-200');
            
            if (isSuccess) {
                statusMessageEl.classList.add('bg-green-800', 'text-green-200');
            } else {
                statusMessageEl.classList.add('bg-red-800', 'text-red-200');
            }

            statusMessageEl.classList.remove('hidden');
            setTimeout(() => statusMessageEl.classList.add('hidden'), 5000);
        }

        /**
         * Display a denial message and clear UI if unauthorized.
         */
        function displayAccessDenied(message) {
            appDashboardEl.classList.add('hidden');
            authContainerEl.classList.remove('hidden');
            
            // Overwrite content for denial message
            authContainerEl.innerHTML = `
                <h2 class="text-3xl font-bold text-red-400 mb-4">Access Denied</h2>
                <p class="text-gray-400 mb-6">${message}</p>
                <button onclick="handleGoogleSignIn()" class="conversion-btn w-full flex items-center justify-center space-x-2 bg-blue-600 hover:bg-blue-700 ring-blue-500/50">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 48 48" width="24px" height="24px" class="text-white fill-current"><path fill="#FFC107" d="M43.611,20.083H42V20H24v8h11.303c-1.649,4.657-6.08,8-11.303,8c-6.627,0-12-5.373-12-12s5.373-12,12-12c3.059,0,5.842,1.158,7.961,3.039l5.657-5.657C34.046,6.053,29.268,4,24,4C12.955,4,4,12.955,4,24s8.955,20,20,20c11.045,0,20-8.955,20-20C44,22.659,43.862,21.35,43.611,20.083z"/><path fill="#FF3D00" d="M6.306,14.691l6.571,4.819C14.655,15.108,18.991,12,24,12c3.059,0,5.842,1.158,7.961,3.039l5.657-5.657C34.046,6.053,29.268,4,24,4C12.955,4,4,12.955,4,24l2.306-9.309z"/><path fill="#4CAF50" d="M24,44c5.166,0,9.86-1.977,13.409-5.192l-6.19-5.238C29.211,35.091,26.715,36,24,36c-5.202,0-9.619-3.317-11.283-7.946l-6.522,5.025C9.505,39.556,16.227,44,24,44z"/><path fill="#1976D2" d="M43.611,20.083H42V20H24v8h11.303c-0.792,2.237-2.231,4.166-4.087,5.571c0.001-0.001,0.002-0.001,0.003-0.002l6.19,5.238C36.971,39.205,44,34,44,24C44,22.659,43.862,21.35,43.611,20.083z"/></svg>
                    <span>Try Again with Google</span>
                </button>
            `;
            showMessage(`Access Denied: ${message.split('.')[0]}`, false);
        }

        /**
         * Checks if the user is authorized (email ends with @agoda.com) and controls UI visibility.
         */
        function checkAccessAndRender(user) {
            if (user) {
                // If user is from the canvas custom token, it might not have an email. 
                // We prioritize Google sign-in for new users.
                const email = user.email;

                if (email && email.toLowerCase().endsWith('@agoda.com')) {
                    // ACCESS GRANTED
                    currentUserId = user.uid;
                    userInfoEl.textContent = `User: ${email} | App ID: ${appId}`;
                    appDashboardEl.classList.remove('hidden');
                    authContainerEl.classList.add('hidden');
                    renderAbbreviations();
                    showMessage(`Welcome, ${user.displayName || email.split('@')[0]}! Access granted.`, true);
                    return;
                } 
                
                // ACCESS DENIED (either no email or wrong domain)
                if (user.isAnonymous) {
                     // If anonymous (from Canvas token attempt), prompt for Google login
                     appDashboardEl.classList.add('hidden');
                     authContainerEl.classList.remove('hidden');
                     return;
                }

                // If non-anonymous but failed domain check, sign out and show denial message
                console.warn(`Access denied for user ID: ${user.uid}`);
                signOut(auth).then(() => {
                    displayAccessDenied("Access is restricted to users with an @agoda.com email address.");
                }).catch(err => {
                    console.error("Error signing out unauthorized user:", err);
                    displayAccessDenied("Unauthorized user detected and sign-out failed.");
                });
            } else {
                // No user is signed in
                currentUserId = null;
                userInfoEl.textContent = 'Please sign in.';
                appDashboardEl.classList.add('hidden');
                authContainerEl.classList.remove('hidden');
            }
        }

        /**
         * Initiates the Google Sign-In process.
         */
        async function handleGoogleSignIn() {
            const provider = new GoogleAuthProvider();
            provider.addScope('email');
            
            try {
                // Request Google sign-in
                await signInWithPopup(auth, provider);
                // onAuthStateChanged will automatically trigger checkAccessAndRender
            } catch (error) {
                console.error("Google Sign-In Error:", error);
                // The pop-up was closed by the user or denied access
                showMessage(`Sign In Failed: Authentication was cancelled or denied.`, false);
            }
        }

        /**
         * Initializes Firebase and authenticates the environment user, then loads the app.
         */
        async function initializeFirebase() {
            if (!firebaseConfig) {
                console.error("Firebase configuration is missing.");
                userInfoEl.textContent = "Error: Firebase config missing.";
                showMessage("Initialization error: Firebase config not found.", false);
                return;
            }

            try {
                app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);

                // 1. Set up the state change listener first. This will handle all access control.
                onAuthStateChanged(auth, checkAccessAndRender);

                // 2. Attempt to sign in via custom token (Canvas environment) if available
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                    console.log("Attempted sign-in with custom token.");
                } else {
                    // Fallback to anonymous sign-in to get a user object for canvas security rules 
                    // before prompting the user for Google sign-in.
                    await signInAnonymously(auth);
                    console.log("Attempted anonymous sign-in.");
                }

            } catch (error) {
                console.error("Error during Firebase initialization or sign-in:", error);
                showMessage(`Auth Error: ${error.message}`, false);
            }
        }
        
        // --- CONVERTER APPLICATION LOGIC (KEPT AS IS) ---
        
        // Lists for UI highlighting only
        const typoTerms = ["Custumer", "Cancllation", "Reservtion", "Pleas"];
        const synonymTerms = [
            "User", "Client", "Patron", "Booker", "Traveller", "Visitor", "Occupant", "Lodger", // PAX synonyms
            "Stay", "Confirmed Stay", "Travel Plan", "Order", "Booked Room", "Lodging", // RSVN synonyms
            "Voiding", "Withdrawal", "Dropping", "Terminate", "Annulment", // CXL synonyms
            "Reimbursement", "Credit", "Money Back", "Repayment", "Return Payment", "Return funds", // RFND synonyms
            "Inn", "Motel", "Hostel", "Lodge", "Accommodation", "Residence", // HTL synonyms
            "Establishment", "Premises", "Venue", "Site", "Building", // PPTY synonyms
            "Check In", "Revert", "Respond", "Get Back", "Update" // F/U synonyms
        ];

        // --- AGODA ABBREVIATION DICTIONARY (kept for reference) ---
        const abbreviationMap = {
            "1 night": "1N", "1 room, 2 adults, 1 child": "1R 2A 1C", "Air conditioning": "A/C", "American Breakfast": "ABF", "Agoda Better Price": "ABP", "Accordingly": "ACC", "Acknowledge(d)": "ACK", "Accept": "ACPT", "Advertisement": "AD", "Additional": "ADD", "Address": "ADDR", "Advise(d)": "ADV", "Alternative": "ALT", "Approve": "APV", "Amend(ed)": "AMD", "Amendment": "AMD", "Amount": "AMT", "Approximately": "APPROX", "Apartment": "APT", "Acquirer Reference Number": "ARN", "Arrive(d)": "ARR", "Arrival": "ARR", "As soon as possible": "ASAP", "Airport Transfer": "ATF", "Account Takeover": "AT", "Authorize": "AUTH", "Available": "AVAIL", "Account holder": "AH", "Alternative Payment Methods": "APM", "Athena - Accommodation - Athena Wizard": "AW", "Because": "B/C", "Blacklist": "B/L", "Backend": "BE", "Breakfast": "BF", "Booking": "BKG", "Booking.com outbound agent/team": "BOT", "Bank Statement": "BS", "Bank Transfer": "BT", "Bank Transfer Form": "BTF", "Communications": "COMMS", "Check in": "C/I", "Check out": "C/O", "Chargeback": "CB", "Credit Card": "CC", "Corporate Credit Card": "CORP CC", "Confirm(ed)": "CFM", "Chat": "CH", "Child": "CHD", "Change(d)": "CHG", "Credit Card On file": "CCOF", "Customer Service": "CS", "Customer Service Department": "CS", "Contact(ed)": "CTC", "Cancel": "CXL", "Cancel(ed)": "CXL", "Cancellation": "CXL", "Cancllation": "CXL", "Cancellation Fee Waiver Tool": "CFWT", "Collect": "COLL", "Conversation": "CONVO", "Canned Response": "CR", "Double Room": "DBL", "Department": "DEPT", "Different": "DIFF", "Difference": "DIFF", "Documentation": "DOC", "Document": "DOC", "Detail": "DTL", "Duplicate": "DUP", "Dedicated": "Ded.", "Non-dedicated": "Non-ded.", "Example": "E.G.", "Extra Bed": "EXB", "Educate": "EDU", "E-mail": "EML", "Email": "EML", "Enquire(d)": "ENQ", "Enquiry": "ENQ", "End of Business day": "EOB", "End of Shift": "EOS", "Escalate(d)": "ESC", "Escalation": "ESC", "Estimated Time of Arrival": "ETA", "Estimated Time of Departure": "ETD", "Exclude(d)": "EXCL", "Excluding": "EXCL", "Extension number": "EXT", "Follow Up": "F/U", "Fully Booked": "FB", "Front Desk": "FD", "Flight": "FLT", "Free of charge": "FOC", "Forward(ed)": "FWD", "Foreign exchange": "FX", "For Your Information": "FYI", "Gesture of goodwill": "GOG", "Guaranteed": "GTD", "Go to Travel Campaign": "GTT", "Hotel": "HTL", "Inn": "HTL", "Motel": "HTL", "Hostel": "HTL", "Lodge": "HTL", "Accommodation": "HTL", "Residence": "HTL", "Hotel voucher": "HTVC", "Hotel confirmation number": "HCN", "Hotelbeds": "HTB", "Hotelbeds Interface": "HTBIF", "Hour": "Hr", "Hours": "Hrs", "In Other Words": "I.E.", "Inbound": "IB", "In-House": "IH", "Inform(ed)": "IFM", "Information": "Info", "Immediate": "IMM", "Include(d)": "INCL", "Including": "INCL", "Inquire(d)": "INQ", "Inquiry": "INQ", "Installment": "INSTL", "International": "INTL", "Internal": "INT", "International transaction fee": "ITF", "Instagram": "IG", "Language Barrier": "LB", "Lead Guest": "LG", "Length of Stay": "LOS", "Medical Certificate": "MC", "Memo Random": "Memo", "Manager": "MGR", "Management": "MGT", "Manage My Booking": "MMB", "Minute": "MIN", "Minutes": "MINS", "Message": "MSG", "Messaging": "MSG", "Marketing": "Mktg", "Monitor by Walking Around": "MBWA", "Night": "N", "Not available": "N/A", "Negotiate": "NEGOT", "negotiation": "NEGOT", "No Further Action": "NFA", "Number": "NO.", "No Show": "NS", "Non Touch Point": "NTP", "Outbound": "OB", "Occupancy": "OCC", "Okay": "OK", "Online Travel Agency": "OTA", "Original": "ORIG", "Customer": "PAX", "Guest": "PAX", "Custumer": "PAX", "User": "PAX", "Client": "PAX", "Patron": "PAX", "Booker": "PAX", "Traveller": "PAX", "Visitor": "PAX", "Occupant": "PAX", "Lodger": "PAX", "Pending Case Automation": "PCA", "Price Freeze": "PF", "Package": "PKG", "Person in charge": "PIC", "Please": "PLS", "Pleas": "PLS", "Policy": "POL", "Period of Stay": "POS", "Possible": "POSS", "Per Person": "PP", "People": "PPL", "Previous": "PREV", "Problem": "PROB", "Promotion": "PROMO", "Promotional": "PROMO", "Property": "PPTY", "Establishment": "PPTY", "Premises": "PPTY", "Venue": "PPTY", "Site": "PPTY", "Building": "PPTY", "Per Room Per Night": "PRPN", "Points": "PTS", "Password": "PW", "Partnership": "P'ship", "Quadruple Room": "QUAD", "Receive(d)": "RCV", "Relevant Department": "RD", "Reconfirm(ed)": "RECFM", "Reference": "REF", "Regarding": "REG", "Request(ed)": "REQ", "Refund(ed)": "RFND", "Reimbursement": "RFND", "Credit": "RFND", "Money Back": "RFND", "Repayment": "RFND", "Return Payment": "RFND", "Return funds": "RFND", "Non-Refundable": "NON-RFND", "Room": "RM", "Reservation": "RSVN", "Reservtion": "RSVN", "Stay": "RSVN", "Confirmed Stay": "RSVN", "Travel Plan": "RSVN", "Order": "RSVN", "Booked Room": "RSVN", "Lodging": "RSVN", "Room type": "RT", "Supporting document": "SD", "Single Room": "SGL", "Secure link": "SL", "Standard Operation Procedure": "SOP", "Special request": "SR", "Smart Search": "SS", "Screenshot": "SS", "Standard Room": "STD", "Supplier": "SUPP", "To Be Advised": "TBA", "Telephone": "TEL", "Through": "THRU", "Tomorrow": "TMR", "Triple Room": "TRP", "Twin Room": "TWN", "Timezone": "TZ", "Travel Operations Back Office": "TOBO", "Transaction": "TXN", "Voucher": "VC", "Voicemail": "VM", "Voice message": "VM", "Voice": "VO", "Validate": "VLDT", "With": "W/", "Within": "W/I", "Whitelist": "W/L", "Without": "W/O", "Years old": "Y. O.", "Allotment Alert": "AA", "Athena Messaging": "ATM", "Avaya Aura Agent Desktop": "AAAD", "Agent Assisted Booking": "AAB", "Awaiting Customer Response": "ACR", "Arabic": "AE", "American Express": "AMEX", "Agoda Private Sale": "APS", "Allotment Reject": "AR", "Auxiliary": "AUX", "AgodaCash": "AC", "Agent Initiated Monitoring": "AIM", "Accommodation Service Team": "AST", "Average Handling Time": "AHT", "Agoda Special Offers": "ASO", "Booking.com": "B.COM", "Business to Business": "B2B", "Business to Customer": "B2C", "Business assurance team": "BA", "Business Development": "BD", "Booking Identification Number": "BID", "Bangkok": "BKK", "Book Now Pay on Check in": "BNPC", "Book Now Pay Later": "BNPL", "Book on Request": "BOR", "Best price guarantee": "BPG", "Agoda price guarantee": "BPG", "Budapest": "BUD", "Bank Identification Number": "BIN", "Backoffice": "BO", "Business Process, Risk and Control dept.": "BPRC", "Backoffice Allotment Reject": "BAR", "Click to Call": "C2C", "Click to Email": "C2EM", "Cashback Rewards": "CBRW", "Csat and Escalation teams": "CED", "Customer Experience Group": "CEG", "Contact ID": "CID", "Mandarin": "CN", "Customer Relation Management": "CRM", "Customer satisfaction": "CSAT", "Credit card security code": "CVV/CVC", "Customer Satisfaction and Incidents Team": "CSI", "Call Back Request": "CBR", "Continue Internal Call": "CIC", "Direct Connect non-Yield Control System": "DC non-YCS", "Day": "D", "Dynamic Currency Conversion": "DCC", "German": "DE", "Disconnect(ed)": "DISC", "Destination Management Company": "DMC", "CN Domestic Team": "DOM", "Direct Message": "DM", "Enterprise Booking Engine": "EBE", "English": "EN", "Email per hour": "EPH", "Spanish": "ES", "Frequently Asked Questions": "FAQ", "First Contact Resolution": "FCR", "Finance Team": "FIN", "Fast Track": "FT", "Foreign Languages": "FL", "Asian foreign languages": "FLA", "European foreign languages": "FLEU", "French": "FR", "Foundation back office": "FBO", "Global Collect": "GC", "Greenwich Mean Time": "GMT", "Go To My Booking": "GTMB", "Grave yard shift team": "GY", "Cantonese": "HK", "Hotels Team": "HOT", "Human Resource": "HR", "Hungarian": "HU", "Hyperwallet": "HW", "Hotel ID": "HID", "Property ID": "HID", "Inbound Pax Touchpoint(s)": "IBPTP", "Identification Number": "ID", "Indonesian": "ID", "Interaction Search": "IS", "Italian": "IT", "Information Technology": "IT", "Interactive Voice Response System": "IVR", "Internal Line Closed": "ILC", "Japan Credit Bureau": "JCB", "Japanese": "JP", "Key Performance Indicator": "KPI", "Korean": "KR", "Kuala Lumpur": "KUL", "Korean Consumer Agency": "KCA", "Last Minute Booking": "LMB", "Local Price": "LP", "Net Inclusive Rate": "LP", "LanguageLine Support": "LLS", "Market Manager": "MM", "Malay": "MY", "Manual Review Box": "MRB", "Malaysia Tourism Tax": "MTTX", "Net Promoter Score": "NPS", "Negative Commission": "NC", "Natural disaster": "ND", "Non Web Collect": "NWC", "Online Training": "OLT", "Operations": "OPS", "Over Time": "OT", "Office of The Consumer Protection Board": "OCPB", "Original Booking Value": "OBV", "Outlook Email Task": "OET", "Offline Payment": "OTC", "Over The Counter Payment": "OTC", "Payment Card Industry Data Security": "PCI-Compliance", "Priceline": "PCLN", "Predefined Content": "PDC", "Public Holiday": "PH", "Payment Team": "PMT", "Payment": "PMT", "Proof of Concept": "POC", "Partner Services": "PS", "Portuguese": "PT", "Providence": "PVD", "PCFW": "PCFW", "Private Message": "PM", "Personal Follow up": "PFU", "Questions and Answers": "Q&A", "Quality Assurance": "QA", "Quick Services": "QS", "Rebook": "RB", "Rewards Backoffice": "RBO", "Refund Request Form": "RRF", "Russian": "RU", "Agoda Website Structure": "ROH", "Reclame Aqui": "REAQ", "Real Time Specialist": "RTS", "Sao Paulo": "SAO", "Shift Coordinator": "SC", "Single Contact Resolution": "SCR", "Specially Designated Nationals": "SDN", "Seoul": "SEL", "Singapore": "SG", "Shanghai": "SHG", "Service Level Agreement": "SLA", "Selling Price": "SP", "Self Service Cancellation Fee Waiver": "SSFW", "Smart Service Identification Number": "SSID", "Specialized Support Team": "SST", "SuperAggregator": "SuperAgg", "Social Media": "SM", "Sharepoint Escalation Task": "SPT", "Sprinklr Case For Social Media Team": "SPK", "Terms & Conditions": "T&C", "Travel Agent": "TA", "Turn around time": "TAT", "Team Captain": "TC", "Thai": "TH", "Team Leader": "TL", "Team Manager": "TM", "Travel Operations": "TO", "Touch point": "TP", "Touch point per day": "TPD", "Touch point per hour": "TPH", "Escalation to TM/ TC": "TME", "Taobao Fliggy Chat": "TFC", "TM/TC assignment": "TMA", "TeQuejaSuma": "TQS", "Time to first response": "TTFR", "Unique Purchasing Card": "UPC", "Universal Resource Locator": "URL", "Urgent Last Minute Booking": "URLMB", "Unique Contact ID": "UCID", "Virtual Classroom Training": "VCT", "Vietnamese": "VN", "Voice per hour": "VPH", "Work Force Management": "WFM", "Working Day(s)": "WD", "World Pay": "WP", "World Wide Web": "WWW", "Walk-in Customer": "WIC", "Work Breakdown Structure": "WBS", "Extensible Markup Language": "XML", "Yield Control System": "YCS", "Yokohama": "YOK", "Voiding": "CXL", "Withdrawal": "CXL", "Dropping": "CXL", "Terminate": "CXL", "Annulment": "CXL", "Check In": "F/U", "Revert": "F/U", "Respond": "F/U", "Get Back": "F/U", "Update": "F/U"
        };
        // ---------------------------------

        /**
         * Generic fetch wrapper with exponential backoff for API calls.
         */
        async function fetchWithExponentialBackoff(url, options, maxRetries = 5) {
            for (let i = 0; i < maxRetries; i++) {
                try {
                    const response = await fetch(url, options);
                    if (response.status !== 429) { 
                        return response;
                    }
                    await new Promise(resolve => setTimeout(resolve, Math.pow(2, i) * 1000 + Math.random() * 1000));
                } catch (error) {
                    await new Promise(resolve => setTimeout(resolve, Math.pow(2, i) * 1000 + Math.random() * 1000));
                }
            }
            throw new Error('API call failed after multiple retries.');
        }

        /**
         * Populates the list of abbreviations in the UI.
         */
        function renderAbbreviations() {
            abbreviationList.innerHTML = '';
            const allTerms = Object.keys(abbreviationMap).sort();

            allTerms.forEach(phrase => {
                const abbreviation = abbreviationMap[phrase];
                const listItem = document.createElement('div');
                
                let phraseClass = 'text-gray-300 font-medium';
                // Use monochrome styling for distinction
                if (typoTerms.includes(phrase)) {
                    // Typos: Bold, italic, and a bottom border/underline look
                    phraseClass = 'text-gray-400 font-bold italic border-b border-gray-400';
                } else if (synonymTerms.includes(phrase) || phrase === "Cancel") {
                    // Synonyms/Related: Stronger italic look
                    phraseClass = 'text-gray-500 font-bold italic';
                }

                listItem.innerHTML = `<span class="${phraseClass}">${phrase}</span> <span class="text-gray-500">â†’</span> <span class="font-bold text-white">${abbreviation}</span>`;
                abbreviationList.appendChild(listItem);
            });
        }
        
        /**
         * Handles the visual state of the AI buttons during processing.
         */
        function setConversionLoading(isLoading, conversionType) {
            const buttons = [abbreviateBtn, expandBtn]; 
            const buttonMap = {
                'abbreviate': abbreviateBtn,
                'expand': expandBtn
            };
            
            // Disable all buttons during an API call
            buttons.forEach(btn => {
                btn.disabled = isLoading;
                btn.classList.toggle('opacity-70', isLoading);
            });

            // Set loading text only for the active button
            if (conversionType in buttonMap) {
                const activeBtn = buttonMap[conversionType];
                if (isLoading) {
                    activeBtn.innerHTML = '<div class="loading-spinner"></div>Converting...';
                } else {
                    // Restore original text for API buttons
                    if (activeBtn.id === 'abbreviateBtn') {
                        activeBtn.innerHTML = 'Abbreviate (AI)';
                    } else if (activeBtn.id === 'expandBtn') {
                        activeBtn.innerHTML = 'Expand Text (AI)';
                    }
                }
            }
        }

        /**
         * Handles the Expansion conversion using the Gemini API for grammar correction.
         */
        async function handleExpandConversion(text) {
            if (!text.trim()) {
                showMessage('Input text is empty. Nothing to expand.', false);
                return;
            }

            setConversionLoading(true, 'expand');
            const originalText = textInput.value;

            try {
                // 1. Prepare the dictionary rules for the AI
                const expansionRules = Object.entries(abbreviationMap)
                    .map(([phrase, abbr]) => `"${abbr.toLowerCase()}" -> "${phrase}"`) 
                    .join('; ');

                // 2. Define the system prompt to enforce the rules and grammar cleanup
                const systemPrompt = `You are a professional quality assurance editor. Your task is to review the user's abbreviated text and convert it into a full, grammatically correct, and professional sentence or paragraph.
                
                **STRICT INSTRUCTIONS:**
                1.  **EXPANSION:** Expand the abbreviations used in the input text based on the following dictionary. Treat the lowercase abbreviations (e.g., 'pax', 'cs') as the keys for expansion.
                2.  **GRAMMAR/READABILITY:** After expansion, rewrite the entire text to ensure perfect grammar, appropriate punctuation, correct capitalization, and fluent, comprehensible sentence structure.
                3.  **OUTPUT:** You must only output the final, clean, and expanded text and nothing else. Do not add greetings, explanations, or any extra content.

                EXPANSION DICTIONARY (Abbreviation -> Full Phrase): ${expansionRules}`;

                const userQuery = `Expand and fully correct the grammar of the following abbreviated note:\n\n${originalText}`;
                
                const apiKey = ""; 
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;

                const payload = {
                    contents: [{ role: "user", parts: [{ text: userQuery }] }],
                    systemInstruction: {
                        parts: [{ text: systemPrompt }]
                    },
                };

                const response = await fetchWithExponentialBackoff(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                const result = await response.json();
                const convertedText = result.candidates?.[0]?.content?.parts?.[0]?.text || '';
                
                if (convertedText) {
                    textInput.value = convertedText.trim();
                    showMessage('Text successfully expanded and corrected using the AI!', true);
                } else {
                    throw new Error("AI returned no text or an unexpected format.");
                }
                
            } catch (error) {
                console.error("AI Expansion Error:", error);
                textInput.value = `Error: Could not perform AI expansion and correction. The original text was: ${originalText}`;
                showMessage('Error: Failed to expand text using AI.', false);
            } finally {
                setConversionLoading(false, 'expand');
            }
        }


        /**
         * Handles the Abbreviation conversion using the Gemini API.
         */
        async function handleAbbreviateConversion(text) {
            if (!text.trim()) {
                showMessage('Input text is empty. Nothing to abbreviate.', false);
                return;
            }

            setConversionLoading(true, 'abbreviate');

            try {
                // 1. Prepare the dictionary rules for the AI
                const abbreviationRules = Object.entries(abbreviationMap)
                    .map(([phrase, abbr]) => `"${phrase}" -> "${abbr}"`)
                    .join('; ');

                // 2. Define the system prompt to enforce the new rules and output format
                const systemPrompt = `You are a professional customer service note-taking bot. Your task is to convert the user's provided text into a **brief, readable sentence**. The final output must read like a compressed sentence, not just a list of keywords.
                
                **STRICT RULE:** You **MUST ONLY** use the abbreviations provided in the RULES list below. Any word or phrase that does not match an entry in the dictionary must be kept as it is in the output. **Crucially, retain necessary functional words (like 'to', 'for', 'the', 'in', 'on', 'and', 'with', 'if') to ensure the note is grammatically readable and flows like a sentence.** All abbreviations used must be rendered in **lowercase**. You must only output the final note and nothing else. Do not add greetings, explanations, or any extra content.

                RULES: ${abbreviationRules}
                
                Example Input: The Customer Service Department needs to know if the Client has an issue regarding their Booked Room and needs a Reimbursement. Please Revert as soon soon as possible.
                Example Output: the cs needs to know if pax has an issue re rsvn and needs a rfnd. pls f/u asap.`; // Updated example to reflect required readability

                const userQuery = `Convert the following text into a short, readable note:\n\n${text}`;
                
                const apiKey = ""; 
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;

                const payload = {
                    contents: [{ role: "user", parts: [{ text: userQuery }] }],
                    systemInstruction: {
                        parts: [{ text: systemPrompt }]
                    },
                };

                const response = await fetchWithExponentialBackoff(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                const result = await response.json();
                const convertedText = result.candidates?.[0]?.content?.parts?.[0]?.text || '';
                
                if (convertedText) {
                    textInput.value = convertedText.trim();
                    showMessage('Text successfully abbreviated using the AI!', true);
                } else {
                    throw new Error("AI returned no text or an unexpected format.");
                }
                
            } catch (error) {
                console.error("AI Abbreviation Error:", error);
                textInput.value = `Error: Could not perform AI abbreviation. The original text was: ${originalText}`;
                showMessage('Error: Failed to convert text using AI.', false);
            } finally {
                setConversionLoading(false, 'abbreviate');
            }
        }

        /**
         * Main conversion router.
         */
        function convertTo(caseType) {
            let text = textInput.value;

            if (caseType === 'abbreviate') {
                handleAbbreviateConversion(text);
                return;
            }
            if (caseType === 'expand') {
                handleExpandConversion(text);
                return;
            }
        }

        function clearText() {
            textInput.value = '';
            showMessage('Text input cleared.', true);
        }

        function copyToClipboard() {
            try {
                textInput.select();
                textInput.setSelectionRange(0, 99999); 
                document.execCommand('copy');

                showMessage('Text successfully copied to clipboard!', true);

            } catch (err) {
                showMessage('Failed to copy text. Please copy manually.', false);
                console.error('Copy command failed:', err);
            }
        }

        // Expose global functions needed by HTML buttons
        window.convertTo = convertTo;
        window.clearText = clearText;
        window.copyToClipboard = copyToClipboard;
        window.handleGoogleSignIn = handleGoogleSignIn;


        // --- Initialization ---
        initializeFirebase();
    </script>
</body>
</html>
